name: PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: read

jobs:
  validate-pr-title:
    name: Validate PR Title
    runs-on:
      group: gusto-ubuntu-default
    steps:
      - name: Check PR title follows conventional commits
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;

            // Conventional commit types (must be lowercase)
            const validTypes = [
              'feat',
              'fix',
              'docs',
              'style',
              'refactor',
              'perf',
              'test',
              'build',
              'ci',
              'chore',
              'revert'
            ];

            // Check for uppercase types (common mistake)
            const uppercaseTypeMatch = title.match(/^([A-Z]+)(\(|!|:)/);
            if (uppercaseTypeMatch) {
              const errorMessage = `
            ‚ùå **PR title uses uppercase type - must be lowercase**

            Your title: \`${title}\`

            The type \`${uppercaseTypeMatch[1]}\` should be lowercase: \`${uppercaseTypeMatch[1].toLowerCase()}\`

            Conventional commits require lowercase types (e.g., \`feat\`, not \`FEAT\`).
            `;
              core.setFailed(errorMessage);
              return;
            }

            // Regex pattern for conventional commits (lowercase types only)
            // Matches: type(optional-scope)!?: description
            const conventionalCommitRegex = new RegExp(
              `^(${validTypes.join('|')})` +  // type (lowercase)
              `(\\([\\w\\-\\/,]+\\))?` +       // optional scope in parentheses
              `!?` +                            // optional breaking change indicator
              `:\\s+.+$`                        // colon, space, and description
            );

            if (!conventionalCommitRegex.test(title)) {
              const errorMessage = `
            ‚ùå **PR title does not follow conventional commits format**

            Your title: \`${title}\`

            **Expected format:** \`type(optional-scope): description\`

            **Valid types and their semver impact (0.x.x pre-release):**
            | Type | Version Bump | Description |
            |------|--------------|-------------|
            | \`feat\` | MINOR | New features |
            | \`fix\` | PATCH | Bug fixes |
            | \`feat!\` or \`fix!\` | MINOR* | Breaking changes (note the \`!\`) |
            | \`docs\` | none | Documentation |
            | \`chore\` | none | Maintenance |
            | \`refactor\` | none | Code refactoring |
            | \`test\` | none | Tests |
            | \`ci\` | none | CI changes |
            | \`style\` | none | Code style |
            | \`perf\` | none | Performance |
            | \`build\` | none | Build system |
            | \`revert\` | none | Reverts |

            *Per semver spec, breaking changes bump MINOR during 0.x.x (pre-1.0)

            **Note:** Types must be lowercase (e.g., \`feat\`, not \`FEAT\`)

            **Examples:**
            - \`feat: add new component\`
            - \`fix: resolve validation issue\`
            - \`feat(SDK-123): add payroll alerts\`
            - \`feat!: redesign JSX component props\` (breaking change)
            - \`chore: update dependencies\`
            `;
              
              core.setFailed(errorMessage);
            } else {
              // Determine version bump type for informational purposes
              const typeMatch = title.match(/^(feat|fix)(\([^)]+\))?(!)?:\s/);
              
              let versionBump = 'none';
              if (typeMatch) {
                const isBreaking = typeMatch[3] === '!';
                if (isBreaking) {
                  versionBump = 'MINOR (breaking change during 0.x.x)';
                } else if (typeMatch[1] === 'feat') {
                  versionBump = 'MINOR';
                } else if (typeMatch[1] === 'fix') {
                  versionBump = 'PATCH';
                }
              }
              
              console.log(`‚úÖ PR title is valid: "${title}"`);
              console.log(`üì¶ Version bump on merge: ${versionBump}`);
            }
